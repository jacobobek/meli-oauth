<!-- /shipments.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Etiquetas & Env√≠os | Panel ML</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg:#0b1020; --card:#10182b; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#090e1d,#0b1228);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Cantarell}
    header{position:sticky;top:0;z-index:5;padding:16px 20px;background:#0d1427cc;border-bottom:1px solid #1f2937;backdrop-filter:blur(8px);display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input,select,button{background:var(--card);color:var(--text);border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
    button{cursor:pointer}
    .ghost{border-color:#29344e}
    .pill{border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px;border:1px solid #1f2937;background:var(--card)}
    th,td{padding:12px 14px;border-bottom:1px solid #1f2937;font-size:14px}
    th{color:var(--muted);text-align:left;background:#0d152e;position:sticky;top:60px}
    tr:hover td{background:rgba(34,211,238,.05)}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .badge{border:1px solid #22304b;border-radius:999px;padding:4px 8px;font-size:12px}
    .b-me1{background:rgba(34,211,238,.08);color:#67e8f9}
    .b-custom{background:rgba(16,185,129,.08);color:#86efac}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid #22304b;background:#131c33}
    .btn:hover{background:#172343}
    .btn-ok{border-color:#0b4b3b}
    .btn-warn{border-color:#5b3f07}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>üì¶ Etiquetas & Env√≠os</h1>
    <div class="row">
      <span class="pill">auto-refresh 15s</span>
      <button id="btnReload" class="btn ghost">Recargar</button>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <select id="filterMode">
        <option value="">ME1 + Custom</option>
        <option value="me1">S√≥lo ME1</option>
        <option value="custom">S√≥lo Custom</option>
      </select>
      <input id="search" placeholder="Buscar buyer / id / t√≠tulo‚Ä¶" style="min-width:260px" />
      <span id="status" class="muted"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Modo</th>
          <th>Orden</th>
          <th>Pago</th>
          <th>Monto</th>
          <th>Comprador</th>
          <th>Producto</th>
          <th>Fecha</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
const API_ORDERS = '/api/meli/orders?mode=me1,custom&payment=approved&limit=50';
const tbody = document.getElementById('tbody');
const filterMode = document.getElementById('filterMode');
const search = document.getElementById('search');
const statusEl = document.getElementById('status');
const btnReload = document.getElementById('btnReload');

let cache = [];

function badgeMode(m) {
  return `<span class="badge ${m==='me1'?'b-me1':'b-custom'}">${m.toUpperCase()}</span>`;
}
function fmtMoney(n){ return (Number(n)||0).toLocaleString('es-AR',{style:'currency',currency:'ARS'}) }
function fmtDate(s){ try{return new Date(s).toLocaleString('es-AR')}catch{return s||''}}

function matches(row, q, m) {
  if (m && row.shipping_mode !== m) return false;
  if (!q) return true;
  const hay = `${row.order_id} ${row.buyer||''} ${row.product_title||''}`.toLowerCase();
  return hay.includes(q);
}

function render() {
  const m = filterMode.value;
  const q = (search.value||'').trim().toLowerCase();
  const rows = cache.filter(r => matches(r,q,m));
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${badgeMode(r.shipping_mode)}</td>
      <td class="mono">${r.order_id}</td>
      <td>${r.payment_status}</td>
      <td>${fmtMoney(r.total_amount)}</td>
      <td>${r.buyer||''}</td>
      <td>${r.product_title||''}</td>
      <td class="mono">${fmtDate(r.date_created)}</td>
      <td>
        <button class="btn btn-ok" onclick='printLabel(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Imprimir etiqueta</button>
        <button class="btn btn-warn" onclick='markShipped(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Marcar enviado</button>
      </td>
    </tr>
  `).join('');
  statusEl.textContent = `Mostrando ${rows.length} / ${cache.length}`;
}

async function load() {
  statusEl.textContent = 'Cargando‚Ä¶';
  const r = await fetch(API_ORDERS, { cache:'no-store' });
  const js = await r.json();
  cache = js.items || [];
  render();
}

async function markShipped(row){
  try{
    const params = new URLSearchParams();
    if (row.shipment_id) params.set('shipment_id', row.shipment_id);
    params.set('order_id', row.order_id);

    const r = await fetch('/api/meli/mark-shipped?' + params.toString());
    const js = await r.json();
    if (js.ok) {
      alert('Marcado (o notado) como enviado ‚úîÔ∏è');
      load();
    } else {
      alert('No se pudo marcar: ' + (js.error||''));
    }
  }catch(e){ alert(e.message) }
}

function printLabel(row){
  if (row.shipment_id) {
    // Intentamos etiqueta oficial
    const url = `/api/meli/label?id=${encodeURIComponent(row.shipment_id)}`;
    const w = window.open(url, '_blank');
    if (!w) alert('Permit√≠ las ventanas emergentes para ver la etiqueta.');
  } else {
    // Generamos una etiqueta simple para "custom"
    const html = `
      <html><head><meta charset="utf-8">
      <title>Etiqueta personalizado</title>
      <style>
        body{font-family:system-ui; margin:20px}
        .box{border:2px dashed #000; padding:16px; width:600px}
        .h{font-size:18px; font-weight:700}
        .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
      </style></head>
      <body onload="setTimeout(()=>window.print(), 200)">
        <div class="box">
          <div class="h">ENV√çO PERSONALIZADO</div>
          <div><b>Orden:</b> <span class="mono">${row.order_id}</span></div>
          <div><b>Comprador:</b> ${row.buyer||''}</div>
          <div><b>Producto:</b> ${row.product_title||''}</div>
          <div><b>Direcci√≥n:</b> ${row.full_address||'(acordar con comprador)'}</div>
          <div><b>Fecha:</b> ${fmtDate(row.date_created)}</div>
          <div><b>Monto:</b> ${fmtMoney(row.total_amount)}</div>
        </div>
      </body></html>
    `;
    const w = window.open('', '_blank');
    if (!w) return alert('Permit√≠ las ventanas emergentes para imprimir.');
    w.document.write(html);
    w.document.close();
  }
}

filterMode.addEventListener('change', render);
search.addEventListener('input', render);
btnReload.addEventListener('click', load);

load();
setInterval(load, 15000);
</script>
</body>
</html>
