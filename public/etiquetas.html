<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Etiquetas · Mercado Libre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/styles.css" rel="stylesheet" />
  <style>
    .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
    .toolbar input, .toolbar select, .toolbar button { padding:8px 10px; border:1px solid #2a3348; background:#0f1527; color:#e5e7eb; border-radius:8px; }
    .badge { padding:3px 7px; border-radius:999px; font-size:12px; border:1px solid #263049; }
    .b-me1 { background:rgba(34,211,238,.1); color:#67e8f9; }
    .b-custom { background:rgba(245,158,11,.12); color:#facc15; }
    .ok { color:#22c55e; }
    .warn { color:#f59e0b; }
    .muted { color:#94a3b8; }
    .btn-sm { padding:6px 10px; border:1px solid #2a3348; background:#0b1220; color:#e5e7eb; border-radius:8px; }
  </style>
</head>
<body>
  <header class="topbar">
    <h1>Etiquetas de Envío · Mercado Libre</h1>
    <nav>
      <button id="btn-err" class="btn-sm muted" style="display:none">Error cargando</button>
      <button id="btn-auto" class="btn-sm">auto-refresh 30s</button>
      <button id="btn-reload" class="btn-sm">Recargar</button>
    </nav>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <input id="q" type="text" placeholder="Buscar por ID / comprador / SKU / producto..." />
      <select id="mode">
        <option value="me1,custom">ME1 + Acordar</option>
        <option value="me1">Solo ME1</option>
        <option value="custom">Solo Acordar</option>
        <option value="all">Todos</option>
      </select>
      <select id="pay">
        <option value="approved">Pagos aprobados</option>
        <option value="pending">Pagos pendientes</option>
        <option value="all">Todos los pagos</option>
      </select>
      <span class="muted" id="status">0 resultados</span>
    </div>

    <div class="card">
      <table class="t">
        <thead>
          <tr>
            <th>Orden</th>
            <th>Comprador</th>
            <th>Pago</th>
            <th>Monto</th>
            <th>Envío</th>
            <th>Producto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <script>
    const rows = document.getElementById('rows');
    const q = document.getElementById('q');
    const mode = document.getElementById('mode');
    const paySel = document.getElementById('pay');
    const statusLine = document.getElementById('status');
    const btnReload = document.getElementById('btn-reload');
    const btnAuto = document.getElementById('btn-auto');
    const btnErr = document.getElementById('btn-err');

    let timer = null, autoOn = false, cache = [];

    const fmtMoney = n => (isNaN(n) ? '—' : n.toLocaleString('es-AR',{style:'currency',currency:'ARS'}));
    const badge = m => m === 'me1' ? '<span class="badge b-me1">ME1</span>' :
                     m === 'custom' ? '<span class="badge b-custom">Acordar</span>' :
                     `<span class="badge">${m || '—'}</span>`;

    function render() {
      const query = q.value.trim().toLowerCase();
      const list = cache.filter(o => {
        if (!query) return true;
        const s = [o.order_id, o.buyer?.name, o.item?.title, o.item?.sku].join(' ').toLowerCase();
        return s.includes(query);
      });

      statusLine.textContent = `${list.length} resultados`;
      rows.innerHTML = list.map(o => `
        <tr>
          <td>
            <div class="mono">${o.order_id}</div>
            <div class="muted mono">${new Date(o.date_created).toLocaleString('es-AR')}</div>
          </td>
          <td>${o.buyer?.name || '—'}</td>
          <td>${o.payment === 'approved' ? '<span class="ok">Aprobado</span>' : '<span class="warn">Pendiente</span>'}</td>
          <td>${fmtMoney(o.amount)}</td>
          <td>${badge(o.shipping?.mode)} <span class="muted">${o.shipping?.status || ''}</span></td>
          <td>
            <div>${o.item?.title || '—'}</div>
            <div class="muted mono">SKU: ${o.item?.sku || '—'} · x${o.item?.qty || 1}</div>
          </td>
          <td>
            <button class="btn-sm" onclick='printLabel(${JSON.stringify(o).replace(/"/g, '&quot;')})'>Imprimir etiqueta</button>
          </td>
        </tr>
      `).join('');
    }

    function printLabel(order) {
      const seller = 'Tu Tienda · CUIT 20-00000000-0'; // si querés, hacelo dinámico
      const buyer = order.buyer?.name || '';
      const prod = order.item?.title || '';
      const sku = order.item?.sku || '';
      const qty = order.item?.qty || 1;

      const html = `
        <html><head><meta charset="utf-8">
        <title>Etiqueta ${order.order_id}</title>
        <style>
          body{font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto; margin:0; padding:16px;}
          .card{width:92mm; min-height:60mm; border:2px solid #000; padding:10px; box-sizing:border-box;}
          h1{font-size:16px;margin:0 0 8px;}
          .mono{font-family: ui-monospace, Menlo, Consolas, monospace;}
          .row{display:flex; justify-content:space-between;}
          .big{font-size:18px;font-weight:700;}
          .muted{color:#333;}
          .hr{border-top:1px dashed #000;margin:8px 0;}
        </style></head><body onload="window.print(); setTimeout(()=>window.close(), 800);">
          <div class="card">
            <div class="row"><div class="big">ENVÍO ${order.shipping?.mode === 'custom' ? 'ACORDAR' : 'ME1'}</div><div class="mono">#${order.order_id}</div></div>
            <div class="hr"></div>
            <div><strong>Producto:</strong> ${prod}</div>
            <div><span class="muted mono">SKU:</span> ${sku || '—'} · <span class="muted mono">Cant:</span> ${qty}</div>
            <div class="hr"></div>
            <div><strong>Comprador:</strong> ${buyer}</div>
            <div><strong>Vendedor:</strong> ${seller}</div>
            <div class="hr"></div>
            <div class="mono">Fecha: ${new Date(order.date_created).toLocaleString('es-AR')}</div>
          </div>
        </body></html>
      `;

      const w = window.open('', '_blank', 'width=800,height=600');
      w.document.write(html);
      w.document.close();
    }

    async function load() {
      try {
        btnErr.style.display = 'none';
        const u = new URL('/api/meli/orders', location.origin);
        u.searchParams.set('mode', mode.value);
        u.searchParams.set('payments', paySel.value);
        u.searchParams.set('limit', '50');

        const res = await fetch(u.toString(), { cache:'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        cache = data.orders || [];
        render();
      } catch (err) {
        btnErr.style.display = 'inline-block';
        console.error(err);
      }
    }

    btnReload.addEventListener('click', load);
    [q, mode, paySel].forEach(el => el.addEventListener('input', () => {
      if (el === mode || el === paySel) load(); else render();
    }));

    btnAuto.addEventListener('click', () => {
      autoOn = !autoOn;
      btnAuto.textContent = autoOn ? 'auto-refresh 30s (ON)' : 'auto-refresh 30s';
      if (autoOn) { if (timer) clearInterval(timer); timer = setInterval(load, 30000); load(); }
      else { if (timer) clearInterval(timer); timer = null; }
    });

    load();
  </script>
</body>
</html>
