<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Etiquetas de EnvÃ­o | Mercado Libre</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--muted:#93a3b8;--text:#e5e7eb;
      --line:#1f2937;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--accent:#22d3ee;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#050815,#0b1220);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    header{
      position:sticky;top:0;z-index:10;backdrop-filter: blur(8px);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 20px;border-bottom:1px solid var(--line);background:rgba(11,18,32,.7)
    }
    h1{margin:0;font-size:16px;letter-spacing:.3px}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input,select,button{
      color:var(--text);background:var(--card);border:1px solid var(--line);
      border-radius:10px;padding:10px 12px;outline:0
    }
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1cc0e6,#0eaecf);border:none}
    button.ghost{background:#0b1220}
    button.bad{background: #2a0f14;border-color:#4b1219;color:#ffb4c0}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b1220}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{color:var(--muted);text-align:left;background:#0d1528;position:sticky;top:61px;z-index:5}
    tr:hover td{background:rgba(34,211,238,.04)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .b-me1{background:rgba(34,211,238,.08);color:#67e8f9}
    .b-custom{background:rgba(245,158,11,.1);color:#f8cf6c}
    .s-paid{color:#86efac;background:rgba(16,185,129,.08)}
    .s-pending{color:#facc15;background:rgba(245,158,11,.08)}
    .s-cancel{color:#ff8b99;background:rgba(239,68,68,.1)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .empty{padding:22px;text-align:center;color:var(--muted)}
    .sr{position:absolute;left:-9999px}
    .toast{position:fixed;right:16px;bottom:16px;background:#0f172a;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(6px);transition:.2s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“¦ Etiquetas de EnvÃ­o Â· Mercado Libre</h1>
    <div class="actions right">
      <span id="status" class="pill">Listo</span>
      <button id="btnAuto" class="pill">auto-refresh 30s</button>
      <button id="btnReload" class="pill">Recargar</button>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <label class="sr" for="q">Buscar</label>
      <input id="q" placeholder="Buscar por ID / compradorâ€¦" style="min-width:260px">
      <label class="sr" for="mode">Modo</label>
      <select id="mode">
        <option value="all">ME1 + Acordar</option>
        <option value="me1">SÃ³lo ME1</option>
        <option value="custom">SÃ³lo Acordar con el vendedor</option>
      </select>
      <select id="paid">
        <option value="approved">Pagos aprobados</option>
        <option value="pending">Pagos pendientes</option>
        <option value="all">Todos los pagos</option>
      </select>
      <span class="pill" id="counter">0 resultados</span>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Orden</th>
            <th>Comprador</th>
            <th>Pago</th>
            <th>Monto</th>
            <th>EnvÃ­o</th>
            <th>Producto</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="empty">Cargandoâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ========= CONFIG =========
    // Endpoints de backend (Node/Vercel). Ver secciÃ³n 2 del mensaje.
    const API = {
      orders: '/api/meli/orders',           // GET   ?mode=me1,custom&payment=approved|pending|all&limit=50
      label:  '/api/meli/label',            // POST  { shipment_id } -> { url | blob }
      shipped:'/api/meli/mark-shipped'      // POST  { order_id }
    };
    const POLL_MS = 30_000;

    // Demo mode: /etiquetas.html?demo=1
    const DEMO = new URL(location.href).searchParams.get('demo') === '1';

    // ========= state =========
    const state = {
      rows: [],
      timer: null,
      auto: false
    };

    // ========= helpers =========
    const $ = sel => document.querySelector(sel);
    const fmt = n => (Number.isFinite(+n) ? (+n).toLocaleString('es-AR', {style:'currency',currency:'ARS'}) : 'â€”');
    const toast = (msg) => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 1800);
    };
    const badgePay = (s) => {
      if (!s) return '<span class="badge s-pending">â€”</span>';
      if (s === 'approved') return '<span class="badge s-paid">Aprobado</span>';
      if (s === 'pending') return '<span class="badge s-pending">Pendiente</span>';
      return `<span class="badge s-cancel">${s}</span>`;
    };
    const badgeMode = (m) => {
      if (m === 'me1') return '<span class="badge b-me1">ME1</span>';
      return '<span class="badge b-custom">Acordar</span>';
    };

    // ========= render =========
    function render() {
      const q = $('#q').value.trim().toLowerCase();
      const mode = $('#mode').value;
      const paid = $('#paid').value;

      const rows = state.rows.filter(r => {
        const okMode = mode === 'all' || r.shipping_mode === mode;
        const okPaid = paid === 'all' || r.payment_status === paid;
        const text = `${r.order_id} ${r.buyer} ${r.title}`.toLowerCase();
        const okQ = !q || text.includes(q);
        return okMode && okPaid && okQ;
      });

      $('#counter').textContent = `${rows.length} resultados`;

      const html = rows.map(r => {
        const canPrint = r.payment_status === 'approved' && !!r.shipment_id;
        const canShip  = r.payment_status === 'approved';

        return `
          <tr>
            <td class="mono">
              #${r.order_id}<br><span class="muted">${new Date(r.date_created).toLocaleString('es-AR')}</span>
            </td>
            <td>${r.buyer || 'â€”'}</td>
            <td>${badgePay(r.payment_status)}</td>
            <td>${fmt(r.total_amount)}</td>
            <td>${badgeMode(r.shipping_mode)}<br><span class="muted mono">${r.shipment_id || 'sin shipment'}</span></td>
            <td>${r.title || 'â€”'}</td>
            <td class="right">
              <div class="actions">
                <button class="primary" ${canPrint?'':'disabled title="Pago no aprobado o sin shipment"'} 
                        data-action="print" data-shipment="${r.shipment_id}">Imprimir etiqueta</button>
                <button class="ghost" ${canShip?'':'disabled title="Pago no aprobado"'}
                        data-action="shipped" data-order="${r.order_id}">Marcar enviado</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      $('#tbody').innerHTML = html || `<tr><td colspan="7" class="empty">Sin resultados</td></tr>`;
    }

    // ========= data =========
    async function fetchOrders() {
      $('#status').textContent = 'Cargandoâ€¦';
      try {
        let data;
        if (DEMO) {
          // Datos fake para probar la UI sin backend
          await new Promise(r => setTimeout(r, 400));
          data = [
            { order_id: 1001, buyer: 'Juan P.', payment_status: 'approved', total_amount: 45200, shipping_mode:'me1', shipment_id: 555001, title:'Cafetera X', date_created: new Date().toISOString() },
            { order_id: 1002, buyer: 'Ana L.',  payment_status: 'pending',  total_amount: 18990, shipping_mode:'custom', shipment_id: null, title:'Set cuchillos', date_created: new Date().toISOString() }
          ];
        } else {
          const params = new URLSearchParams({
            mode: $('#mode').value === 'all' ? 'me1,custom' : $('#mode').value,
            payment: $('#paid').value,
            limit: 50
          });
          const res = await fetch(`${API.orders}?${params.toString()}`,{cache:'no-store'});
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          data = await res.json(); // debe ser array de objetos normalizados
        }

        state.rows = Array.isArray(data) ? data : [];
        render();
        $('#status').textContent = `OK Â· ${state.rows.length} Ã³rdenes`;
      } catch (err) {
        console.error(err);
        $('#status').textContent = 'Error cargando';
        $('#tbody').innerHTML = `<tr><td colspan="7" class="empty">Error cargando Ã³rdenes</td></tr>`;
      }
    }

    async function printLabel(shipment_id) {
      try {
        $('#status').textContent = 'Generando etiquetaâ€¦';
        let url;
        if (DEMO) {
          await new Promise(r => setTimeout(r, 500));
          // Abrimos un PDF pÃºblico de prueba:
          url = 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf';
        } else {
          const res = await fetch(API.label, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ shipment_id })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json(); // { url } o { dataUrl }
          url = json.url || json.dataUrl;
        }
        if (url) window.open(url, '_blank');
        toast('Etiqueta lista');
        $('#status').textContent = 'OK';
      } catch (e) {
        console.error(e);
        toast('No se pudo generar la etiqueta');
        $('#status').textContent = 'Error';
      }
    }

    async function markShipped(order_id) {
      if (!confirm(`Â¿Marcar orden #${order_id} como enviada?`)) return;
      try {
        $('#status').textContent = 'Actualizando envÃ­oâ€¦';
        if (!DEMO) {
          const res = await fetch(API.shipped, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ order_id })
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
        } else {
          await new Promise(r => setTimeout(r, 400));
        }
        toast('Orden marcada como enviada');
        fetchOrders();
      } catch (e) {
        console.error(e);
        toast('No se pudo actualizar el estado');
        $('#status').textContent = 'Error';
      }
    }

    // ========= events =========
    $('#tbody').addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      if (action === 'print')  printLabel(btn.dataset.shipment);
      if (action === 'shipped') markShipped(btn.dataset.order);
    });

    $('#q, #mode, #paid').addEventListener('input', render);
    $('#btnReload').addEventListener('click', fetchOrders);
    $('#btnAuto').addEventListener('click', ()=>{
      state.auto = !state.auto;
      $('#btnAuto').classList.toggle('primary', state.auto);
      $('#btnAuto').textContent = state.auto ? 'auto-refresh 30s (ON)' : 'auto-refresh 30s';
      if (state.timer) clearInterval(state.timer);
      if (state.auto) state.timer = setInterval(fetchOrders, POLL_MS);
    });

    // primera carga
    fetchOrders();
  </script>
</body>
</html>
