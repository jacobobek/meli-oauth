<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mercado Libre</title>
  <style>
    :root {
      --bg: #0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
           background: linear-gradient(180deg, #060b1b, #0b122a); color:var(--text); }
    header { padding:16px 20px; display:flex; gap:12px; align-items:center;
             background: rgba(15,23,42,.6); border-bottom:1px solid #1f2937; position:sticky; top:0;}
    h1 { margin:0; font-size:18px; }
    .pill { font-size:12px; color:var(--muted); padding:6px 10px; background:#0b1220; border:1px solid #1f2937; border-radius:999px; cursor:pointer;}
    .container { max-width:1100px; margin:18px auto; padding:0 12px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:12px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px 14px; border-bottom:1px solid #1f2937; font-size:14px; }
    th { text-align:left; color:var(--muted); background:#0d1326; position:sticky; top:56px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace; }
    #status { margin-left:auto; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>Libre</h1>
    <button id="btn-auto" class="pill">auto-refresh 10s</button>
    <button id="btn-reload" class="pill">Recargar</button>
    <span id="status">—</span>
  </header>

  <div class="container">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Estado</th><th>Monto</th><th>Comprador</th><th>Fecha</th>
            <th>Topic</th><th>User</th><th>ID</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Usa la URL ABSOLUTA a tu API:
    const API_URL = "https://meli-oauth.vercel.app/api/meli-summary";

    const $tbody = document.getElementById("tbody");
    const $status = document.getElementById("status");
    const $btnReload = document.getElementById("btn-reload");
    const $btnAuto = document.getElementById("btn-auto");

    let timer = null;
    let autoOn = false;

    function fmtMoney(n) {
      const v = Number(n);
      if (!isFinite(v)) return "—";
      try { return v.toLocaleString("es-AR", { style:"currency", currency:"ARS" }); }
      catch { return `$ ${v.toFixed(2)}`; }
    }
    function fmtDate(d) {
      if (!d) return "—";
      try { return new Date(d).toLocaleString("es-AR"); }
      catch { return String(d); }
    }
    function safe(v, fallback="—") { return (v ?? "") !== "" ? v : fallback; }
    function pick(obj, paths) {
      for (const p of paths) {
        const v = p.split(".").reduce((acc,k)=>acc?.[k], obj);
        if (v !== undefined && v !== null) return v;
      }
      return undefined;
    }

    async function load() {
      try {
        $status.textContent = "Cargando…";
        // Para depurar fácilmente:
        console.log("[dashboard] GET", API_URL);

        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        console.log("[dashboard] data:", data);

        let rows = Array.isArray(data) ? data : (data.events || []);
        if (!Array.isArray(rows)) rows = [];

        $tbody.innerHTML = "";

        if (rows.length === 0) {
          $tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:16px;">Sin datos</td></tr>`;
          $status.textContent = "OK · 0 registros";
          return;
        }

        for (const item of rows) {
          const id       = safe(pick(item, ["id","order_id","resource_id","order.id"]), "—");
          const estado   = safe(pick(item, ["status","order_status","order.status"]), "—");
          const monto    = fmtMoney(pick(item, ["amount","total_amount","order.total_amount"]));
          const comp     = safe(pick(item, ["buyer.nickname","buyer.name","payer.nickname","payer.email"]), "—");
          const fecha    = fmtDate(pick(item, ["date_created","created_at","order.date_created","timestamp"]));
          const topic    = safe(pick(item, ["topic","resource","notification_type"]), "—");
          const user     = safe(pick(item, ["user_id","user","seller.id"]), "—");

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${estado}</td>
            <td>${monto}</td>
            <td>${comp}</td>
            <td class="mono">${fecha}</td>
            <td class="mono">${topic}</td>
            <td class="mono">${user}</td>
            <td class="mono">${id}</td>`;
          $tbody.appendChild(tr);
        }

        $status.textContent = `OK · ${rows.length} registros`;
      } catch (err) {
        console.error("[dashboard] error:", err);
        $status.textContent = `Error: ${err.message}`;
        $tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:16px;">Error al cargar</td></tr>`;
      }
    }

    $btnReload.addEventListener("click", load);
    $btnAuto.addEventListener("click", () => {
      autoOn = !autoOn;
      $btnAuto.textContent = autoOn ? "auto-refresh 10s (ON)" : "auto-refresh 10s";
      if (autoOn) {
        if (timer) clearInterval(timer);
        timer = setInterval(load, 10000);
        load();
      } else {
        if (timer) clearInterval(timer);
        timer = null;
      }
    });

    load();
  </script>
</body>
</html>
