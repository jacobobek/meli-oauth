<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Mercado Libre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1224;--card:#0f172a;--muted:#94a3b8;--text:#e5e7eb;
      --line:#1f2937;--accent:#22d3ee;--ok:#10b981;--err:#ef4444;
      --badge:#1f2a44
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#060b1b,#0b122a);color:var(--text)}
    header{position:sticky;top:0;z-index:5;display:flex;gap:12px;
      align-items:center;justify-content:space-between;padding:16px 18px;
      background:rgba(11,18,36,.7);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    h1{margin:0;font-size:16px;letter-spacing:.3px}
    .actions{display:flex;gap:8px;align-items:center}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;background:#0a1120;border:1px solid var(--line);border-radius:999px;cursor:default}
    .btn{cursor:pointer}
    .container{max-width:1200px;margin:18px auto;padding:0 14px}
    .filters{display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap}
    select,input{background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);font-size:14px}
    th{position:sticky;top:60px;background:#0d1326;text-align:left;color:var(--muted)}
    tr:hover td{background:rgba(34,211,238,.04)}
    .mono{font-family:ui-monospace,Menlo,Consolas,"Courier New",monospace}
    .muted{color:var(--muted)}
    .status{font-size:12px}
    .status[data-tone="ok"]{color:var(--ok)}
    .status[data-tone="error"]{color:var(--err)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:var(--badge);font-size:12px}
    .b-type-orden{color:#67e8f9;background:rgba(34,211,238,.08)}
    .b-type-envio{color:#86efac;background:rgba(16,185,129,.08)}
    .b-type-pregunta{color:#facc15;background:rgba(245,158,11,.08)}
    /* Env√≠o (logistic type) */
    .b-me1{color:#c4b5fd;background:rgba(167,139,250,.13)}
    .b-me2{color:#93c5fd;background:rgba(96,165,250,.12)}
    .b-full{color:#6ee7b7;background:rgba(16,185,129,.10)}
    .b-otro{color:#fda4af;background:rgba(244,63,94,.10)}
    .right{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <header>
    <h1>üìä Mercado Libre</h1>
    <div class="right">
      <span id="status-line" class="status muted" data-tone="muted">‚Äî</span>
      <div class="actions">
        <button id="btn-auto" class="pill btn" title="Auto refresh cada 10s">auto-refresh 10s</button>
        <button id="btn-reload" class="pill btn">Recargar</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="filters">
      <select id="f-type">
        <option value="">Todos los tipos</option>
        <option value="orden">√ìrdenes</option>
        <option value="env√≠o">Env√≠os</option>
        <option value="pregunta">Preguntas</option>
        <option value="evento">Otros</option>
      </select>
      <input id="f-search" type="text" placeholder="Buscar por ID / comprador / estado / user‚Ä¶" />
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>ID</th>
            <th>Estado</th>
            <th>Monto</th>
            <th>Comprador</th>
            <th>Fecha</th>
            <th>Topic</th>
            <th>User</th>
            <th>Env√≠o</th> <!-- NUEVA -->
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
  (() => {
    const API = '/api/meli-summary';
    const $ = s => document.querySelector(s);

    const tbody = $('#tbody');
    const statusLine = $('#status-line');
    const fType = $('#f-type');
    const fSearch = $('#f-search');
    const btnReload = $('#btn-reload');
    const btnAuto = $('#btn-auto');

    let rowsCache = [];
    let autoTimer = null;
    let autoOn = false;

    // Helpers
    const fmtMoney = n => (n==null||isNaN(n)) ? '' : n.toLocaleString('es-AR',{style:'currency',currency:'ARS'});
    const fmtDate  = d => !d ? '' : new Date(d).toLocaleString('es-AR');
    const pick = (obj, paths) => {
      for (const p of paths) {
        const v = p.split('.').reduce((a,k)=>a?.[k], obj);
        if (v !== undefined && v !== null) return v;
      }
      return undefined;
    };
    const badgeType = t => {
      const v = String(t||'').toLowerCase();
      if (v.startsWith('orden') || v === 'order') return '<span class="badge b-type-orden">Orden</span>';
      if (v.startsWith('env')) return '<span class="badge b-type-envio">Env√≠o</span>';
      if (v.startsWith('preg')) return '<span class="badge b-type-pregunta">Pregunta</span>';
      return '<span class="badge">Evento</span>';
    };
    const badgeLogistic = lt => {
      if (!lt) return '';
      const v = String(lt).toLowerCase();
      if (v==='me1') return '<span class="badge b-me1">ME1</span>';
      if (v==='me2') return '<span class="badge b-me2">ME2</span>';
      if (v==='fulfillment' || v==='full') return '<span class="badge b-full">FULL</span>';
      return `<span class="badge b-otro">${lt}</span>`;
    };
    const setStatus = (msg, tone='muted') => { statusLine.textContent = msg; statusLine.dataset.tone = tone; };

    // Render
    function render(){
      const typeSel = fType.value.trim().toLowerCase();
      const q = fSearch.value.trim().toLowerCase();

      const filtered = rowsCache.filter(r=>{
        const t = (r.type||'').toLowerCase();
        const matchesType = !typeSel || t === typeSel;
        const hay = `${r.id} ${r.status} ${r.buyer} ${r.user} ${r.logistic}`.toLowerCase();
        return matchesType && (!q || hay.includes(q));
      });

      tbody.innerHTML = filtered.map(r => `
        <tr>
          <td>${badgeType(r.type)}</td>
          <td class="mono">${r.id||''}</td>
          <td>${r.status||''}</td>
          <td>${r.amount != null ? fmtMoney(Number(r.amount)) : ''}</td>
          <td>${r.buyer || ''}</td>
          <td class="mono">${fmtDate(r.date) || ''}</td>
          <td class="muted mono">${r.topic||''}</td>
          <td class="muted mono">${r.user||''}</td>
          <td>${badgeLogistic(r.logistic)}</td>
        </tr>
      `).join('');
      setStatus(`OK ¬∑ ${filtered.length} registros`, 'ok');
    }

    // Load
    async function load(){
      try{
        setStatus('Cargando‚Ä¶', 'muted');
        const res = await fetch(API, { cache:'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();

        const arr = Array.isArray(json) ? json : (json.rows || []);
        rowsCache = arr.map(e => {
          const type = pick(e, ['type','topic','notification_type']) || 'evento';
          const id = pick(e, ['id','order_id','resource_id','order.id','payment_id','shipment_id']) || '';
          const status = pick(e, ['status','order_status','order.status','payment.status','shipment.status']) || '';
          const amount = pick(e, ['amount','total_amount','order.total_amount','transaction_amount','payment.transaction_amount']);
          const buyer = pick(e, ['buyer.nickname','buyer.name','buyer','payer.nickname','payer.email']) || '';
          const date = pick(e, ['date','date_created','created_at','order.date_created','timestamp']);
          const topic = pick(e, ['topic','resource','notification_type']) || '';
          const user = pick(e, ['user','user_id','seller.id']) || '';
          // NUEVO: logistic type desde varias rutas posibles
          const logistic = pick(e, [
            'logistic_type',
            'shipping.logistic_type',
            'order.shipping.logistic_type',
            'shipment.logistic_type'
          ]) || '';

          // Normalizamos etiqueta tipo para filtros (orden/env√≠o/pregunta/evento)
          let typeLabel = String(type).toLowerCase();
          if (typeLabel === 'order' || typeLabel.startsWith('orden')) typeLabel = 'orden';
          else if (typeLabel.startsWith('env')) typeLabel = 'env√≠o';
          else if (typeLabel.startsWith('preg')) typeLabel = 'pregunta';
          else typeLabel = 'evento';

          return { type:typeLabel, id, status, amount, buyer, date, topic, user, logistic };
        });

        render();
      }catch(err){
        console.error(err);
        setStatus(`Error: ${err.message}`, 'error');
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:16px;">Error al cargar</td></tr>`;
      }
    }

    // Eventos UI
    btnReload.addEventListener('click', load);
    fType.addEventListener('change', render);
    fSearch.addEventListener('input', render);
    btnAuto.addEventListener('click', ()=>{
      autoOn = !autoOn;
      btnAuto.textContent = autoOn ? 'auto-refresh 10s (ON)' : 'auto-refresh 10s';
      if (autoOn){
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(load, 10_000);
        load();
      }else{
        clearInterval(autoTimer);
        autoTimer = null;
      }
    });

    // Primera carga
    load();
  })();
  </script>
</body>
</html>
