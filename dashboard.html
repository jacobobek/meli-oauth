<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resumen Mercado Libre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --green: #10b981;
      --red: #ef4444;
      --amber: #f59e0b;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans";
      color: var(--text);
      background: linear-gradient(180deg, #070b18, #0c1226);
    }
    header {
      position: sticky; top: 0; z-index: 50;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 14px 18px;
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { margin: 0; font-size: 18px; }
    .actions { display: flex; gap: 8px; align-items: center; }
    .pill {
      font-size: 12px; color: var(--muted); border: 1px solid var(--border);
      background: #0b1220; padding: 6px 10px; border-radius: 999px; cursor: pointer;
    }
    .pill[data-on="1"] { color: #a5f3fc; border-color: #155e75; background: #082231; }
    .container { max-width: 1100px; margin: 18px auto; padding: 0 14px; }
    .filters { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .filters select, .filters input {
      background: var(--card); color: var(--text); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 10px; outline: none;
    }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { text-align: left; color: var(--muted); background: #0d1326; position: sticky; top: 60px; z-index: 5; }
    tr:hover td { background: rgba(34, 211, 238, 0.05); }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
    .b-orden { background: rgba(34,211,238,.08); color: #67e8f9; }
    .b-envio { background: rgba(16,185,129,.08); color: #86efac; }
    .b-preg { background: rgba(245,158,11,.08); color: #facc15; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { color: var(--muted); }
    .status { margin: 10px 0 14px; color: var(--muted); font-size: 13px; }
    .status[data-tone="ok"] { color: #86efac; }
    .status[data-tone="error"] { color: #fca5a5; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Resumen Mercado Libre</h1>
    <div class="actions">
      <span id="btn-auto" class="pill" data-on="0">auto-refresh 10s</span>
      <button id="btn-reload" class="pill">Recargar</button>
    </div>
  </header>

  <div class="container">
    <div id="status" class="status">Cargandoâ€¦</div>

    <div class="filters">
      <select id="typeFilter">
        <option value="">Todos los tipos</option>
        <option value="order">Ã“rdenes</option>
        <option value="shipment">EnvÃ­os</option>
        <option value="question">Preguntas</option>
        <option value="event">Otros</option>
      </select>
      <input id="search" type="text" placeholder="Buscar por ID / comprador / estadoâ€¦" />
    </div>

    <div class="card">
      <table>
        <thead>
        <tr>
          <th>Tipo</th>
          <th>ID</th>
          <th>Estado</th>
          <th>Monto</th>
          <th>Comprador</th>
          <th>Fecha</th>
          <th class="muted">Topic</th>
          <th class="muted">User</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
  (function () {
    const API = '/api/meli-summary'; // <- tu endpoint
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const selType = document.getElementById('typeFilter');
    const inpSearch = document.getElementById('search');
    const btnReload = document.getElementById('btn-reload');
    const btnAuto = document.getElementById('btn-auto');

    let dataCache = [];
    let autoTimer = null;

    const badge = (t) => {
      const type = String(t || '').toLowerCase();
      if (type.includes('order')) return '<span class="badge b-orden">Orden</span>';
      if (type.includes('ship'))  return '<span class="badge b-envio">EnvÃ­o</span>';
      if (type.includes('quest')) return '<span class="badge b-preg">Pregunta</span>';
      return '<span class="badge">Evento</span>';
    };
    const fmtMoney = (n) => (n == null || isNaN(n)) ? '' :
      n.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
    const fmtDate = (d) => {
      if (!d) return '';
      try { return new Date(d).toLocaleString('es-AR'); } catch { return d; }
    };

    function setStatus(msg, tone = '') {
      statusEl.textContent = msg;
      statusEl.dataset.tone = tone;
    }

    function render() {
      const q = inpSearch.value.trim().toLowerCase();
      const typeSel = selType.value.trim().toLowerCase();

      const rows = dataCache.filter(r => {
        const okType = !typeSel || String(r.type || '').toLowerCase().includes(typeSel);
        const hay = [
          r.id, r.status, r.buyer, r.user, r.topic, r.amount
        ].join(' ').toLowerCase();
        const okSearch = !q || hay.includes(q);
        return okType && okSearch;
      });

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${badge(r.type)}</td>
          <td class="mono">${r.id ?? ''}</td>
          <td>${r.status ?? ''}</td>
          <td>${r.amount != null ? fmtMoney(Number(r.amount)) : ''}</td>
          <td>${r.buyer ?? ''}</td>
          <td class="mono">${fmtDate(r.date)}</td>
          <td class="muted mono">${r.topic ?? ''}</td>
          <td class="muted mono">${r.user ?? ''}</td>
        </tr>
      `).join('');
    }

    async function load() {
      try {
        setStatus('Cargandoâ€¦');
        const res = await fetch(API, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();

        // ðŸ‘‡ clave: ahora tomamos rows (y si no, events por fallback)
        const arr = json?.rows || json?.events || [];
        // normalizo a la forma que espera la UI
        dataCache = arr.map(e => ({
          type:  e.type  ?? e.topic ?? 'event',
          id:    e.id    ?? e.order_id ?? e.resource_id ?? '',
          status:e.status ?? e.order_status ?? '',
          amount:e.amount ?? e.total_amount ?? e.transaction_amount ?? '',
          buyer: e.buyer ?? e?.payer?.nickname ?? e?.payer?.email ?? '',
          date:  e.date  ?? e.date_created ?? e.created_at ?? e.timestamp ?? '',
          topic: e.topic ?? e.resource ?? e.notification_type ?? '',
          user:  e.user  ?? e.user_id ?? e?.seller?.id ?? ''
        }));

        setStatus(`OK Â· ${dataCache.length} registros`, 'ok');
        render();
      } catch (err) {
        console.error(err);
        setStatus('Error cargando datos: ' + err.message, 'error');
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:16px;">Error al cargar</td></tr>`;
      }
    }

    // Eventos
    selType.addEventListener('change', render);
    inpSearch.addEventListener('input', render);
    btnReload.addEventListener('click', load);
    btnAuto.addEventListener('click', () => {
      const on = btnAuto.dataset.on === '1';
      if (on) {
        clearInterval(autoTimer); autoTimer = null;
        btnAuto.dataset.on = '0'; btnAuto.textContent = 'auto-refresh 10s';
      } else {
        btnAuto.dataset.on = '1'; btnAuto.textContent = 'auto-refresh 10s (ON)';
        autoTimer = setInterval(load, 10000);
        load();
      }
    });

    // Primera carga
    load();
  })();
  </script>
</body>
</html>
