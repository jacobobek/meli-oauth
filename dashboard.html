<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resumen Mercado Libre</title>
  <style>
    :root {
      --bg: #0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --row:#0b1220; --border:#1f2937; --accent:#22d3ee;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
           background: linear-gradient(180deg,#060b1b,#0b122a); color:var(--text); }
    header { display:flex; justify-content:space-between; align-items:center;
             padding:16px 20px; border-bottom:1px solid var(--border);
             position:sticky; top:0; background:rgba(15,23,42,.7); backdrop-filter: blur(8px); }
    h1 { margin:0; font-size:18px; }
    .actions { display:flex; gap:8px; }
    .btn { border:1px solid var(--border); background:var(--row); color:var(--text);
           padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn[data-on="1"] { outline:1px solid var(--accent); }
    .container { max-width:1100px; margin:20px auto; padding:0 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:12px 14px; border-bottom:1px solid var(--border); font-size:14px; }
    th { background:#0d1326; color:var(--muted); text-align:left; position:sticky; top:56px; }
    tr:hover td { background:rgba(34,211,238,.04); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; }
    .muted { color:var(--muted); }
    #status { margin:10px 0; font-size:13px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Resumen Mercado Libre</h1>
    <div class="actions">
      <button id="btn-auto" class="btn">auto-refresh 10s</button>
      <button id="btn-reload" class="btn">Recargar</button>
    </div>
  </header>

  <div class="container">
    <div id="status">Cargandoâ€¦</div>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>ID</th>
            <th>Estado</th>
            <th>Monto</th>
            <th>Comprador</th>
            <th>Fecha</th>
            <th class="muted">Topic</th>
            <th class="muted">User</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = '/api/meli-summary';
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const btnReload = document.getElementById('btn-reload');
    const btnAuto = document.getElementById('btn-auto');
    let timer = null, autoOn = false;

    const fmtMoney = (n) => {
      if (n == null || isNaN(n)) return '';
      try { return n.toLocaleString('es-AR', {style:'currency', currency:'ARS'}); }
      catch { return `$ ${Number(n).toFixed(2)}`; }
    };
    const fmtDate = (d) => d ? new Date(d).toLocaleString('es-AR') : '';
    const pick = (obj, paths) => {
      for (const p of paths) {
        const v = p.split('.').reduce((a,k)=>a?.[k], obj);
        if (v != null) return v;
      }
      return undefined;
    };
    const safe = (v, f='') => (v==null ? f : v);

    async function load() {
      try {
        statusEl.textContent = 'Cargandoâ€¦';
        const res = await fetch(API_URL, { cache:'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        tbody.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          statusEl.textContent = '0 registros';
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:16px;">Sin datos</td></tr>';
          return;
        }

        for (const item of data) {
          const tipo = safe(pick(item, ['type','resource','topic','notification_type']));
          const id = safe(pick(item, ['id','order_id','resource_id','order.id','payment_id','shipment_id']));
          const estado = safe(pick(item, ['status','order_status','order.status','payment.status','shipment.status']));
          const monto = fmtMoney(Number(pick(item, ['amount','total_amount','order.total_amount','transaction_amount','payment.transaction_amount'])));
          const comprador = safe(pick(item, ['buyer.nickname','buyer.name','buyer','payer.nickname','payer.email']));
          const fecha = fmtDate(pick(item, ['date_created','created_at','order.date_created','timestamp']));
          const topic = safe(pick(item, ['topic','resource','notification_type']));
          const user = safe(pick(item, ['user_id','user','seller.id']));

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${tipo}</td>
            <td class="mono">${id}</td>
            <td>${estado}</td>
            <td>${monto}</td>
            <td>${comprador}</td>
            <td class="mono">${fecha}</td>
            <td class="muted mono">${topic}</td>
            <td class="muted mono">${user}</td>
          `;
          tbody.appendChild(tr);
        }
        statusEl.textContent = `OK Â· ${data.length} registros`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Error: ${err.message}`;
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:16px;">Error al cargar</td></tr>';
      }
    }

    btnReload.addEventListener('click', load);
    btnAuto.addEventListener('click', () => {
      autoOn = !autoOn;
      btnAuto.dataset.on = autoOn ? '1' : '0';
      btnAuto.textContent = autoOn ? 'auto-refresh 10s (ON)' : 'auto-refresh 10s';
      if (autoOn) {
        if (timer) clearInterval(timer);
        timer = setInterval(load, 10000);
        load();
      } else {
        if (timer) clearInterval(timer);
        timer = null;
      }
    });

    // primera carga
    load();
  </script>
</body>
</html>
