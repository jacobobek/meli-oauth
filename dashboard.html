<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Mercado Libre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --green: #10b981;
      --red: #ef4444;
      --amber: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans";
      background: linear-gradient(180deg, #060b1b, #0b122a);
      color: var(--text);
    }
    header {
      padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; backdrop-filter: blur(8px); background: rgba(15, 23, 42, 0.6); border-bottom: 1px solid #1f2937;
    }
    header h1 { margin: 0; font-size: 18px; letter-spacing: .4px; color: #fff; }
    header .actions { display: flex; gap: 8px; align-items: center; }
    .pill { font-size: 12px; color: var(--muted); padding: 6px 10px; background: #0b1220; border: 1px solid #1f2937; border-radius: 999px; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .filters { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .filters select, .filters input {
      background: var(--card); color: var(--text); border: 1px solid #1f2937; border-radius: 8px; padding: 8px 10px;
    }
    .card {
      background: var(--card); border: 1px solid #1f2937; border-radius: 12px; overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 14px; border-bottom: 1px solid #1f2937; font-size: 14px; }
    th { text-align: left; color: var(--muted); background: #0d1326; position: sticky; top: 60px; }
    tr:hover td { background: rgba(34, 211, 238, 0.04); }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #1f2937; }
    .b-orden { background: rgba(34, 211, 238, .08); color: #67e8f9; }
    .b-envio { background: rgba(16, 185, 129, .08); color: #86efac; }
    .b-pregunta { background: rgba(245, 158, 11, .08); color: #facc15; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Resumen Mercado Libre</h1>
    <div class="actions">
      <span class="pill">auto-refresh 10s</span>
      <button id="btnReload" class="pill">Recargar</button>
    </div>
  </header>

  <div class="container">
    <div class="filters">
      <select id="typeFilter">
        <option value="">Todos los tipos</option>
        <option value="Orden">Ã“rdenes</option>
        <option value="EnvÃ­o">EnvÃ­os</option>
        <option value="Pregunta">Preguntas</option>
        <option value="Evento">Otros</option>
      </select>
      <input type="text" id="search" placeholder="Buscar por ID / comprador / estado..." />
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>ID</th>
            <th>Estado</th>
            <th>Monto</th>
            <th>Comprador</th>
            <th>Fecha</th>
            <th class="muted">Topic</th>
            <th class="muted">User</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const tbody = document.getElementById("tbody");
    const selType = document.getElementById("typeFilter");
    const inpSearch = document.getElementById("search");
    const btnReload = document.getElementById("btnReload");

    let cache = [];

    const badge = (type) => {
      if (type === "Orden") return '<span class="badge b-orden">Orden</span>';
      if (type === "EnvÃ­o") return '<span class="badge b-envio">EnvÃ­o</span>';
      if (type === "Pregunta") return '<span class="badge b-pregunta">Pregunta</span>';
      return '<span class="badge">Evento</span>';
    };

    function render() {
      const type = selType.value.trim().toLowerCase();
      const q = inpSearch.value.trim().toLowerCase();

      const rows = cache.filter(e => {
        const okType = !type || e.type.toLowerCase() === type;
        const text = (e.id||"") + " " + (e.status||"") + " " + (e.buyer||"") + " " + (e.user_id||"");
        const okSearch = !q || text.toLowerCase().includes(q);
        return okType && okSearch;
      });

      tbody.innerHTML = rows.map(e => `
        <tr>
          <td>${badge(e.type)}</td>
          <td class="mono">${e.id || ""}</td>
          <td>${e.status || ""}</td>
          <td>${e.amount != null ? "$ " + e.amount : ""}</td>
          <td>${e.buyer || ""}</td>
          <td class="mono">${e.date || ""}</td>
          <td class="muted mono">${e.rawTopic || ""}</td>
          <td class="muted mono">${e.user_id || ""}</td>
        </tr>
      `).join("");
    }

    async function load() {
      const res = await fetch("/api/meli-summary");
      const json = await res.json();
      cache = json.events || [];
      render();
    }

    selType.addEventListener("change", render);
    inpSearch.addEventListener("input", render);
    btnReload.addEventListener("click", load);

    load();
    setInterval(load, 10000);
  </script>
</body>
</html>
