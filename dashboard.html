<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ã“rdenes | Mercado Libre</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">ðŸ“¦ Ã“rdenes</div>
    <nav>
      <a class="active" href="./dashboard.html">Ã“rdenes</a>
      <a href="./etiquetas.html">Etiquetas</a>
      <a href="./index.html">Inicio</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="toolbar">
        <select id="typeFilter">
          <option value="">Todos los envÃ­os</option>
          <option value="me1">ME1 / Fulfillment</option>
          <option value="acordar">Acordar con el vendedor</option>
        </select>
        <input id="search" type="search" placeholder="Buscar por ID / comprador / estado..." />
        <div class="spacer"></div>
        <button id="reload" class="btn">Recargar</button>
      </div>

      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>ID</th>
              <th>Estado</th>
              <th>Monto</th>
              <th>Comprador</th>
              <th>Fecha</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="status" class="status muted">Cargandoâ€¦</div>
    </section>
  </main>

  <script src="./app.js"></script>
  <script>
    const tbody   = document.getElementById('tbody');
    const filter  = document.getElementById('typeFilter');
    const search  = document.getElementById('search');
    const status  = document.getElementById('status');
    const reload  = document.getElementById('reload');

    let cache = [];

    function setStatus(msg, tone='muted'){ status.textContent = msg; status.dataset.tone = tone; }

    function matchesShippingType(order) {
      // NormalizÃ¡ tus campos reales aquÃ­ segÃºn tu /api/meli-summary
      const shipping = (order.shipping_method || order.logistic_type || order.shipping?.logistic_type || '').toLowerCase();
      const val = filter.value;
      if (!val) return true;
      if (val === 'me1') return /me1|fulfillment|me|mercado envios/.test(shipping);
      if (val === 'acordar') return /acordar|seller|to_agree/.test(shipping);
      return true;
    }

    function render() {
      const q = search.value.trim().toLowerCase();
      const rows = cache
        .filter(o => matchesShippingType(o))
        .filter(o => {
          const txt = [
            o.id, o.status, o.buyer, o.buyer_email, o.order_id, o.shipping_method
          ].join(' ').toLowerCase();
          return !q || txt.includes(q);
        });

      tbody.innerHTML = rows.map(o => {
        const monto = fmtMoney(o.amount ?? o.total_amount);
        const fecha = fmtDate(o.date ?? o.date_created);
        const id    = o.id ?? o.order_id ?? '';
        const ship  = (o.shipping_method || o.logistic_type || '').toUpperCase();
        return `
          <tr>
            <td><span class="badge">${ship || 'â€”'}</span></td>
            <td class="mono">${id}</td>
            <td>${o.status || 'â€”'}</td>
            <td>${monto}</td>
            <td>${o.buyer || o.buyer_nickname || 'â€”'}</td>
            <td class="mono">${fecha}</td>
            <td>
              <button class="btn small" onclick='printLabel(${JSON.stringify(o)})'>
                Imprimir etiqueta
              </button>
            </td>
          </tr>
        `;
      }).join('') || `<tr><td colspan="7" class="muted center">Sin datos</td></tr>`;
    }

    function printLabel(order) {
      // Guarda el pedido y abre la vista de etiqueta
      localStorage.setItem('selected_order', JSON.stringify(order));
      window.open('./etiquetas.html', '_blank');
    }

    async function load() {
      try {
        setStatus('Cargandoâ€¦');
        const res = await fetch('/api/meli-summary', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        // SoportÃ¡ ambos formatos: array directo o {events:[...]}
        cache = Array.isArray(data) ? data : (data.events || []);
        setStatus(`OK Â· ${cache.length} registros`, 'ok');
        render();
      } catch (e) {
        setStatus('Error al cargar: ' + e.message, 'error');
        tbody.innerHTML = `<tr><td colspan="7" class="center">No se pudo cargar.</td></tr>`;
      }
    }

    filter.addEventListener('change', render);
    search.addEventListener('input', render);
    reload.addEventListener('click', load);

    load();
  </script>
</body>
</html>
